(function(m,g){typeof exports=="object"&&typeof module<"u"?g(exports):typeof define=="function"&&define.amd?define(["exports"],g):(m=typeof globalThis<"u"?globalThis:m||self,g(m.screenShot={}))})(this,(function(m){"use strict";const g=(l,n={},r="")=>{const c=document.createElement(l);for(let d in n)c.setAttribute(d,n[d]);return c.innerHTML=r,c},A=(l,n)=>(document.getElementById(l)||document.getElementsByTagName("head")[0].prepend(g("STYLE",{type:"text/css"},n)),!0),D=function(l={}){let n,r,c,d,u,w;A("geocam-screenshot-button",`
  .geocam-screenshot-button {
       background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxZW0iIGhlaWdodD0iMWVtIiB2aWV3Qm94PSIwIDAgMjQgMjQiPjxwYXRoIGZpbGw9ImN1cnJlbnRDb2xvciIgZD0iTTQgNGgzbDItMmg2bDIgMmgzYTIgMiAwIDAgMSAyIDJ2MTJhMiAyIDAgMCAxLTIgMkg0YTIgMiAwIDAgMS0yLTJWNmEyIDIgMCAwIDEgMi0ybTggM2E1IDUgMCAwIDAtNSA1YTUgNSAwIDAgMCA1IDVhNSA1IDAgMCAwIDUtNWE1IDUgMCAwIDAtNS01bTAgMmEzIDMgMCAwIDEgMyAzYTMgMyAwIDAgMS0zIDNhMyAzIDAgMCAxLTMtM2EzIDMgMCAwIDEgMy0zIi8+PC9zdmc+');
    }
  .geocam-viewshot-button {
       background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxZW0iIGhlaWdodD0iMWVtIiB2aWV3Qm94PSIwIDAgMjQgMjQiPjxwYXRoIGZpbGw9ImN1cnJlbnRDb2xvciIgZD0iTTQgNWgzbDItMmg2bDIgMmgzYTIgMiAwIDAgMSAyIDJ2MTJhMiAyIDAgMCAxLTIgMkg0YTIgMiAwIDAgMS0yLTJWN2EyIDIgMCAwIDEgMi0ybTkuMDkgNC40NWwtMi4wNCAyLjczbDEuNTUgMi4wN2wtLjg3LjY2bC0yLjQ2LTMuMjdMNiAxNmgxMnoiLz48L3N2Zz4=');
    }
  `);const f=a=>{if(u){const o={action:"screenshot",payload:{img:a,url:document.location.href}};u.postMessage(o)}},y=function(a,o,t){return new Promise(i=>{const e=new Image;e.onload=function(){const s=document.createElement("canvas"),h=s.getContext("2d");s.width=Math.min(o,e.width),s.height=o*e.height/e.width,h.drawImage(e,0,0,s.width,s.height),s.toBlob(i,a.type,t)},e.src=URL.createObjectURL(a)})},v=async a=>{const o=n.renderer.domElement;o.style.filter="invert(1)";let t=await new Promise(e=>o.toBlob(e));w&&(t=await y(t,w,.9));const i=[new ClipboardItem({[t.type]:t})];await navigator.clipboard.write(i),f(t),o.style.removeProperty("filter")},C=async a=>{document.body.style.filter="invert(1)";const o=n.renderer.domElement,t=o.getBoundingClientRect(),i=d.container.getBoundingClientRect(),e={top:Math.min(t.top,i.top),left:Math.min(t.left,i.left),bottom:Math.max(t.bottom,i.bottom),right:Math.max(t.right,i.right)};e.width=e.right-e.left,e.height=e.bottom-e.top;const s=document.createElement("canvas");s.width=e.width,s.height=e.height;const h=s.getContext("2d"),T=await d.takeScreenshot(),I=new Image;I.src=T.dataUrl,await new Promise(b=>{I.onload=b}),t.witdh>i.width||t.height>i.height?(h.drawImage(o,t.left-e.left,t.top-e.top),h.drawImage(I,i.left-e.left,i.top-e.top)):(h.drawImage(I,i.left-e.left,i.top-e.top),h.drawImage(o,t.left-e.left,t.top-e.top));let M=await new Promise(b=>s.toBlob(b));w&&(M=await y(M,w,.9));const S=[new ClipboardItem({[M.type]:M})];await navigator.clipboard.write(S),f(M),document.body.style.removeProperty("filter")};this.init=function(a){n=a,r=g("DIV",{class:"geocam-screenshot-button geocam-viewer-control-button",title:"Copy a screenshot of the current viewer image to the clipboard"}),n.addControl(r,"left-top"),r.addEventListener("click",v,!1);const o=l.channel;o&&"BroadcastChannel"in window&&(u=new BroadcastChannel(o),console.log("broadcasting on channel",o)),w=parseInt(l.maxWidth)},this.arcgisView=function(a){console.log("screen shot add view",a),d||(d=a,c=g("DIV",{class:"geocam-viewshot-button geocam-viewer-control-button",title:"Copy a screenshot of the current viewer image and map to the clipboard"}),n.addControl(c,"left-top",{after:r}),c.addEventListener("click",C,!1))},this.destroy=function(){c&&n.wrapper.removeChild(c),n.wrapper.removeChild(r)}};class p extends HTMLElement{constructor(){super(),this.plugin=null,console.log("screen-shot init")}connectedCallback(){console.log("screen-shot connected");const n=this.closest("geocam-viewer");if(!n){console.error("GeocamViewerScreenShot must be a child of GeocamViewer");return}const r=()=>{const c=n.viewer;c&&typeof c.plugin=="function"?(this.plugin=new D({channel:this.getAttribute("channel"),maxWidth:this.getAttribute("max-width")}),c.plugin(this.plugin)):setTimeout(r,50)};r()}disconnectedCallback(){this.plugin=null,console.log("screen-shot disconnected")}}window.customElements.define("geocam-viewer-screen-shot",p),m.GeocamViewerScreenShot=p,Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})}));
